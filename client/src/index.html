<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Client</title>
  <base href="/">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>
<body>
<app-root></app-root>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://cdn.pubnub.com/pubnub.min.js"></script>
<script src="https://codepen.io/hunh-h-mai-trinh/pen/VqbvJp.js" ></script>
<script src="https://cdn.pubnub.com/webrtc/rtc-controller.js"></script>
<script src="https://cdn.pubnub.com/pubnub-3.7.14.min.js"></script>
<script src="https://cdn.pubnub.com/pubnub-dev.js"></script>
<script type="text/javascript">
  function init() {
    window.phone = PHONE({
      number: window.userid || "Anonymous", // listen on username line else Anonymous
      publish_key: 'pub-c-7198594f-afc9-41c6-90d5-0550167baa42', // Your Pub Key
      subscribe_key: 'sub-c-19694406-fd5f-11e8-849f-127435af060e', // Your Sub Key
      ssl: true
    });

    window.ctrl = CONTROLLER(window.phone, get_xirsys_servers);
    window.ctrl.ready(function () {
      console.log('ready',' to phone ');
    });
    window.ctrl.receive(function (session) {

      console.log("voice call")
      if (window.audio_out != null)
        console.log('abc','abc');
      session.connected(function (session) {
        window.audio_out.appendChild(session.audio);
      });
      session.ended(function (session) {
        window.audio_out.innerHTML = '';
      });
      window.ctrl.videoToggled(function(session, isEnabled){
        ctrl.getVideoElement(session.number).toggle(isEnabled);
      })
      window.ctrl.audioToggled(function (session, isEnabled) {
        window.ctrl.getVideoElement(session.number).css("opacity", isEnabled ? 1 : 0.75);
      })


    });
    if (window.partnerid != 'null')
      console.log('partner id', window.partnerid);
    window.ctrl.dial(window.parnerid,get_xirsys_servers);

  }



  function get_xirsys_servers() {
    var servers;
    $.ajax({
      type: 'POST',
      url: 'https://service.xirsys.com/ice',
      data: {
        room: 'default',
        application: 'default',
        domain: 'talecall.herokuapp.com',
        chanel: 'TaleCall',
        secret: 'e848c73e-17b7-11e9-8661-3f535a2dbe34',
        secure: 1,
      },
      success: function (res) {
        console.log(res);
        var newData = JSON.stringify(res)
        res = JSON.parse(newData);
        if (!res.e) servers = res.d.iceServers;
      },
      async: false
    });
    return servers;
  }

  function hangUp() {
    window.phone.hangup()
    console.log("hang up")
  }


  function mute() {
    var audio = window.ctrl.toggleAudio();
    console.log("mute")
    if (!audio) $("#mute").html("Unmute");
    else $("#mute").html("Mute");
  }
  </script>
</body>


</html>
